<div class="home-navbar-container">
  <div class="home-navbar-home">
    <p><%= link_to 'Home', root_path %></p>
  </div>
  <% if user_signed_in? %>
    <div class="home-navbar-shop">
      <p><%= link_to 'My Shop', user_shop_path(current_user) %></p>
    </div>
    <div class="home-navbar-cart">
      <p><%= link_to 'My Cart', cart_path(current_user.cart) %></p>
    </div>
  <% end %>
  <div class="home-navbar-login">
    <% if user_signed_in? %>
      <p>
        <%= link_to current_user.username, user_path(current_user) %>
        (<%= link_to 'Logout', destroy_user_session_path, method: :delete %>)
      </p>
    <% else %>
      <p>
        <span class="login"><%= link_to 'Login', new_user_session_path %></span>
        - access shop & cart
      </p>
    <% end %>
  </div>
</div>

<div class="sc-header">
  <h1>
    <%= current_user.admin ? "#{@cart.user.username}'s Cart" : "Shopping Cart" %>
  </h1>
</div>

<table class="sc-main-table cart">
  <thead>
    <tr>
      <th colspan="2"></th>
      <th>Price</th>
      <th>Quantity</th>
    </tr>
  </thead>

  <tbody>
    <% @cart.baskets.order(:id).each do |basket| %>
      <tr>
        <td class="sc-image-container">
          <%= link_to image_tag(basket.product.photo_url(:homepage)), product_path(basket.product) %>
        </td>
        <td class="sc-name-container">
          <p>
            <%= link_to basket.product.name, product_path(basket.product) %>
            by <%= link_to basket.product.user.username, user_path(basket.product.user) %>
          </p>
          <p>Quantity available:
            <% if basket.product.quantity > 0 %>
              <%= basket.product.quantity %>
            <% else %>
              <span>Out of stock</span>
            <% end %>
          </p>
          <p>
            Ratings: 3 / 5 |
            <%= link_to 'Remove item', baskets_path(basket_id: basket.id), method: :delete,
                  data: { confirm: 'This item will be removed from your cart. Are you sure?' } %>
          </p>
        </td>
        <td class="sc-price-container">
          <p>$<%= sprintf('%.2f', basket.product.unitprice) %></p>
        </td>
        <td class="sc-quantity-container">
          <%= form_with url: baskets_path(basket_id: basket.id), method: :patch do |form| %>
            <p>
              <%= form.select :quantity, options_for_select((0..basket.product.quantity), basket.quantity),
                  {}, { onchange: 'this.form.submit();' } %>
            </p>
          <% end %>
        </td>
      </tr>
      <% @subtotal_items += basket.quantity %>
      <% @subtotal_price += basket.quantity * basket.product.unitprice %>
    <% end %>

    <tr>
      <td colspan="4" class="sc-subtotal">
        <p>
          Subtotal (<%= @subtotal_items %> items): $<%= sprintf('%.2f', @subtotal_price) %>
        </p>
      </td>
    </tr>
  </tbody>
</table>
